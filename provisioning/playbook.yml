---
- hosts: all
  sudo: true
  gather_facts: no

  vars:
    site: testapp
    app_root: /opt/sites/{{site}}

  roles:
    - common
    - nginx
    - uwsgi
    - postgresql
    - djangoapp

- hosts: none
  sudo: yes
  sudo_user: postgres
  gather_facts: no

  vars:
    dbname: polefit
    dbpassword: mysupersecretpassword

  tasks:
  - name: ensure database is created
    postgresql_db: name={{dbname}}

  - name: ensure user has access to database
    postgresql_user: db={{dbname}} name={{dbname}} password={{dbpassword}} priv=ALL

  - name: ensure user does not have unnecessary privilege
    postgresql_user: name={{dbname}} role_attr_flags=NOSUPERUSER,NOCREATEDB
